"use strict";var Task=React.createClass({displayName:"Task",getInitialState:function(){return{}},onDoubleClick:function(e){e.preventDefault();var t=[{type:"view",title:"概况"},{type:"edit",title:"编辑"},{type:"log",title:"进展"}];ReactDOM.render(React.createElement(TaskDialog,{task:this.props.task,tabs:t,project:this.props.project,onTaskChanged:this.props.onTaskChanged}),document.getElementById("modal_task_"+this.props.task.id))},render:function(){var e=this.props.task,t="root"!==e.parent?"treegrid-parent-"+e.parent:"",a=0===e.automode?"自动":"手动",s={marginRight:"0px"},n={created:"uk-text-primary",doing:"uk-text-warning",commit:"uk-text-warning",completed:"uk-text-success",cancel:"uk-text-danger",pending:"uk-text-warning"},r="created"==e.status?formatDate(e.plan_start_time):formatDate(e.start_time),i="created"==e.status?formatDate(e.plan_end_time):0===e.end_time?"无":formatDate(e.end_time),o="created"==e.status?"":"uk-text-primary",l=e.isCompleted?"uk-text-primary":"",c=[];return e.rely.forEach(function(e,t){c.push(this.props.project.TaskMap[e].index)}.bind(this)),React.createElement("tr",{id:e.id,key:e.id,onDoubleClick:this.onDoubleClick,className:"treegrid-"+e.id+" "+t},React.createElement("td",{className:"uk-block-muted"},React.createElement("button",{className:"uk-button-link dv-link",style:s},this.props.index)),React.createElement("td",null,e.name,React.createElement("div",{id:"modal_task_"+e.id,className:"uk-modal"})),React.createElement("td",{className:"uk-text-center"},React.createElement("i",{className:"uk-icon-circle "+n[e.status]})),React.createElement("td",null,e.executor_name),React.createElement("td",null,React.createElement("span",{className:l},e.isCompleted?e.duration:e.plan_duration)),React.createElement("td",null,a),React.createElement("td",null,React.createElement("span",{className:o},r)),React.createElement("td",null,React.createElement("span",{className:o},i)),React.createElement("td",null,c.toString()||"无"))}}),TaskTable=React.createClass({displayName:"TaskTable",getInitialState:function(){return{taskLen:0,changed_cnt:0,update_cnt:0}},initTree:function(e){e=e||{},$(".tree").treegrid({treeColumn:1,expanderExpandedClass:"uk-icon-folder-open-o",expanderCollapsedClass:"uk-icon-folder-o",nodeClasses:{task:"uk-icon-tasks"},draggable:"rw"===this.props.mode,renderOnDrag:!1,onMove:this.dragTask,selectable:!0,selectedClass:"dv-row-selected",onSelected:e.onSelected,leafClass:"uk-icon-leaf"})},dragTask:function(e,t,a){var s=this.props.project.TaskMap;s[e].parent!==t&&(this.props.handleMoveTo(t,e),console.log("Move task "+s[e].name+" from "+("root"===a||null===a?"root":s[a].name)+" to "+s[t].name))},resetTree:function(){this.initTree({onSelected:this.props.onTaskSelected})},onTaskChanged:function(){this.setState({changed_cnt:this.state.changed_cnt++})},componentDidUpdate:function(){this.props.tasks.length!==this.state.taskLen&&(this.resetTree(),this.setState({taskLen:this.props.tasks.length})),this.props.project.update_cnt!==this.state.update_cnt&&(this.resetTree(),this.setState({update_cnt:this.props.project.update_cnt}))},render:function(){var e={width:"5%"};return React.createElement("div",null,React.createElement("table",{id:"treeTask",className:"tree uk-table uk-width-1-1 uk-table-condensed"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",{style:e},"标识"),React.createElement("th",{className:"uk-width-3-10"},"任务名称"),React.createElement("th",{style:e},"状态"),React.createElement("th",{className:"uk-width-1-10"},"负责人"),React.createElement("th",{className:"uk-width-1-10"},"工期(小时)"),React.createElement("th",{className:"uk-width-1-10"},"计划模式"),React.createElement("th",{className:"uk-width-1-10"},"开始时间"),React.createElement("th",{className:"uk-width-1-10"},"结束时间"),React.createElement("th",{className:"uk-width-1-10"},"前置任务"))),React.createElement("tbody",null,this.props.tasks.map(function(e,t){return React.createElement(Task,{key:e.id,task:e,index:t,project:this.props.project,onTaskChanged:this.onTaskChanged})}.bind(this)))))}}),ToolBar=React.createClass({displayName:"ToolBar",getInitialState:function(){return{new_task_parent:"root",selected_task:"root",disabledDown:!0,disabledUp:!0,disabledRoot:!0}},handleNewTask:function(e){this.setState({new_task_parent:e})},handleMove:function(e){var t,a=this.state.selected_task,s=this.props.project.TaskMap[a],n=this.props.project.tasks;if(postJSON("/api/project/task/"+s.id+"/move",{action:e},function(e,t){e&&fatal(e)}),"up"===e){for(s.order--,t=s.index-1;t>=0;t--)if(n[t].parent===s.parent){n[t].order++;break}}else if("down"===e)for(s.order++,t=s.index+1;t<n.length;t++)if(n[t].parent===s.parent){n[t].order--;break}this.props.onTaskOrderChanged(),this.resetMoveStatus(a)},handleMoveToRoot:function(){this.props.handleMoveTo("root"),this.resetMoveStatus(this.state.selected_task)},resetMoveStatus:function(e){for(var t=this.props.project.TaskMap[e],a=this.props.project.tasks,s=t.order,n=t.index+1;n<a.length;n++){var r=a[n];if(r.parent===t.parent){s=r.order;break}}this.setState({disabledDown:t.order===s,disabledUp:0===t.order,disabledRoot:"root"===t.parent})},componentWillReceiveProps:function(e){if(e.selected_task!==this.state.selected_task){var t=e.selected_task;this.resetMoveStatus(t),this.setState({selected_task:t})}},render:function(){return React.createElement("div",{className:"uk-grid"},React.createElement("div",{className:"uk-width-1-3"},"添加任务：",React.createElement("a",{className:"dv-link",href:"#modal_new_task",onClick:this.handleNewTask.bind(this,"root"),"data-uk-modal":"{center:true}"},"顶级"),"、",React.createElement("a",{className:"dv-link",href:"#modal_new_task",onClick:this.handleNewTask.bind(this,this.props.evaluateTaskParent(this.props.selected_task)),"data-uk-modal":"{center:true}"},"同级"),"、",React.createElement("a",{className:"dv-link",href:"#modal_new_task",onClick:this.handleNewTask.bind(this,this.props.selected_task),"data-uk-modal":"{center:true}"},"下属"),React.createElement(NewTaskDlg,{users:this.props.users,project:this.props.project,parent:this.state.new_task_parent,onNewTask:this.props.onNewTask})),React.createElement("div",{className:"uk-width-1-3"},"移动：",React.createElement("button",{className:"uk-button-link dv-link",onClick:this.handleMove.bind(this,"up"),disabled:this.state.disabledUp},"上移"),"、",React.createElement("button",{className:"uk-button-link dv-link",onClick:this.handleMove.bind(this,"down"),disabled:this.state.disabledDown},"下移"),"、",React.createElement("button",{className:"uk-button-link dv-link",onClick:this.handleMoveToRoot,disabled:this.state.disabledRoot},"置为顶级")),React.createElement("ul",{className:"uk-nav uk-nav-menu","data-uk-scrollspy-nav":"{closest:'li', smoothscroll:false}"},React.createElement("li",null,"添加任务"),React.createElement("li",null,React.createElement("a",{className:"dv-link",href:"#modal_new_task",onClick:this.handleNewTask.bind(this,"root"),"data-uk-modal":"{center:true}"},"顶级")),React.createElement("li",null,React.createElement("a",{className:"dv-link",href:"#modal_new_task",onClick:this.handleNewTask.bind(this,this.props.evaluateTaskParent(this.props.selected_task)),"data-uk-modal":"{center:true}"},"同级")),React.createElement("li",null,React.createElement("a",{className:"dv-link",href:"#modal_new_task",onClick:this.handleNewTask.bind(this,this.props.selected_task),"data-uk-modal":"{center:true}"},"下属")),React.createElement("li",null,"移动任务"),React.createElement("li",null,React.createElement("button",{className:"uk-button-link dv-link",onClick:this.handleMove.bind(this,"up"),disabled:this.state.disabledUp},"上移")),React.createElement("li",null,React.createElement("button",{className:"uk-button-link dv-link",onClick:this.handleMove.bind(this,"down"),disabled:this.state.disabledDown},"下移")),React.createElement("li",null,React.createElement("button",{className:"uk-button-link dv-link",onClick:this.handleMoveToRoot,disabled:this.state.disabledRoot},"置为顶级"))))}}),Project=React.createClass({displayName:"Project",getInitialState:function(){return{project:{},users:[],tasks:[],selected_task:"root",UserMap:{},TaskMap:{}}},onNewTask:function(e){getJSON("/api/project/task/"+e,function(e,t){if(!e){var a=t,s=this.state.tasks;a.executor_name=this.state.UserMap[a.executor_id].name,a.manager_name=this.state.UserMap[a.manager_id].name,a.isCompleted="completed"==a.status,this.state.TaskMap[a.id]=a,s.push(a),this.sortTasks(s),this.setState({tasks:s})}}.bind(this))},hasBloodRelation:function(e,t){var a=this.evaluateTaskAncestor(e),s=this.evaluateTaskAncestor(t);return-1!==a.indexOf(t)||-1!==s.indexOf(e)?(console.log("hasBloodRelation"),!0):!1},onTaskSelected:function(e){this.setState({selected_task:e})},onTaskOrderChanged:function(){var e=this.state.tasks;this.sortTasks(e),this.setState({tasks:e})},handleMoveTo:function(e,t){var a,s=t||this.state.selected_task,n=this.state.TaskMap[s],r=this.state.tasks,i={action:"update_parent",parent:e};if(n.parent!==e){for(a=n.index+1;a<r.length;a++){var o=r[a];o.parent===n.parent&&o.order--}var l=-1;for(a=0;a<r.length;a++){var o=r[a];o.parent===e&&(l=Math.max(l,o.order))}n.parent=e,n.order=l+1,postJSON("/api/project/task/"+n.id+"/move",i,function(e,t){e&&fatal(e)}),this.sortTasks(r),this.state.project.update_cnt++,this.setState({tasks:r})}},makeUserMap:function(e){e.forEach(function(e){this.state.UserMap[e.user_id]=e}.bind(this))},makeTaskMap:function(e){var t=this.state.TaskMap;t.root={id:"root",name:"root",parent:"none"},e.forEach(function(e){t[e.id]=e})},getTaskById:function(e){return this.state.TaskMap[e]},taskIsLeaf:function(e){for(var t=this.state.tasks,a=this.state.TaskMap[e].index+1;a<t.length;a++)if(t[a].parent===e)return!1;return!0},evaluateTaskParent:function(e){var t=this.state.TaskMap;return t.hasOwnProperty(e)&&"root"!==e?t[e].parent:"root"},evaluateTaskAncestor:function(e){var t=this.state.TaskMap,a=[];if(t.hasOwnProperty(e)&&"root"!==e){var s=e;do{var n=t[s];a.unshift(n.parent),s=n.parent}while("root"!==s)}return a},sortTasks:function(e){function t(e){for(var t=0;t<e.length;t++){var a=e[t];"root"===a.parent?a.level=1:a.level=n[a.parent].level+1}}function a(e){var t,a,s;for(t=0;t<e.length;t++)s=e[t],s.total_duration=s.duration;for(t=0;t<e.length;t++){s=e[t];var n=0;for(a=t+1;a<e.length;a++){var r=e[a];if(r.level<=s.level)break;n+=r.duration}s.total_duration+=n}}var s,n=this.state.TaskMap;for(e.sort(function(e,t){if(e.parent===t.parent)return e.order-t.order;for(var a=this.evaluateTaskAncestor(e.id),s=this.evaluateTaskAncestor(t.id),r=Math.max(a.length,s.length),i=0;r>i;i++){if(i>=a.length)return e.order-n[s[i]].order<=0?-1:1;if(i>=s.length)return n[a[i]].order-t.order>=0?1:-1;if(a[i]!==s[i])return n[a[i]].order-n[s[i]].order}return 0}.bind(this)),s=0;s<e.length;s++){var r=e[s];r.index=s,r.isLeaf=this.taskIsLeaf.bind(this,r.id)}return t(e),a(e),e},loadTaskRelies:function(e){getJSON("/api/project/p/"+this.props.id+"/taskrelylist",function(t,a){readyElement("vm"),t?fatal(t):(a.forEach(function(e,t){var a=this.state.TaskMap[e.task_id];a&&a.rely.push(e.rely_task_id)}.bind(this)),this.setState({tasks:e}))}.bind(this))},loadTasks:function(){getJSON("/api/project/p/"+this.props.id+"/tasklist",function(e,t){if(e)fatal(e);else{this.makeTaskMap(t);var a=this.sortTasks(t);t.forEach(function(e,t){e.executor_name=this.state.UserMap[e.executor_id].name,e.manager_name=this.state.UserMap[e.manager_id].name,e.isCompleted="completed"==e.status,e.rely=[]}.bind(this)),this.loadTaskRelies(a),this.state.project.tasks=a}}.bind(this))},componentWillMount:function(){loadingElement("vm"),getJSON("/api/project/p/"+this.props.id,function(e,t){e?fatal(e):(this.makeUserMap(t.members),t.UserMap=this.state.UserMap,t.TaskMap=this.state.TaskMap,t.update_cnt=0,this.setState({project:t,users:t.members}),this.loadTasks())}.bind(this))},render:function(){return React.createElement("div",{className:"uk-width-1-1"},React.createElement("h2",{className:"x-title"},"项目: ",this.state.project.name),"ro"===this.props.mode?null:React.createElement(ToolBar,{users:this.state.users,onNewTask:this.onNewTask,project:this.state.project,onTaskOrderChanged:this.onTaskOrderChanged,selected_task:this.state.selected_task,evaluateTaskParent:this.evaluateTaskParent,handleMoveTo:this.handleMoveTo}),React.createElement("hr",{className:"dv-hr"}),React.createElement(TaskTable,{project:this.state.project,tasks:this.state.tasks,onTaskSelected:this.onTaskSelected,getTaskById:this.getTaskById,handleMoveTo:this.handleMoveTo,mode:this.props.mode}))}});