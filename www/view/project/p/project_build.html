{% extends '../project_base.html' %}

{% block head %}
<script src="/static/js/uikit/components/datepicker.js"></script>
<script src="/static/js/react.js"></script>
<script src="/static/js/react-dom.js"></script>
<script src="/static/js/browser.min.js"></script>

<script type="text/babel">
var TaskMap = {},
	UserMap = {};

function makeTaskMap(ts){
	TaskMap['root'] = { id:'root', name:'root', parent: 'none' };
	ts.forEach(function(t){
		TaskMap[t.id] = t;
	});
}

function evaluateTaskParent(id){
	if( !TaskMap.hasOwnProperty(id) || id === 'root'){
		return 'root';
	}
	return TaskMap[id].parent;
}

function evaluateTaskAncestor(id){
	var as = [];
	if( TaskMap.hasOwnProperty(id) && id !== 'root' ){
		var tid = id;
		do{
			var a = TaskMap[tid];
			as.unshift(a.parent);
			tid = a.parent;
		}while(tid!=='root');
	}
	return as;
}

/*key-value: parent - task object*/
function makeTaskParentMap(ts){
	var map = {root:[]};
	ts.forEach(function(t){
		if( map.hasOwnProperty(t.parent)){
			map[t.parent].push(t);
		}else{
			map[t.parent] = [t];
		}
	});
	return map;
}

/*key-value: parent - task object*/
function makeUserMap(us){
	us.forEach(function(u){
		UserMap[u.id] = u;
	});
}

function sortTasks( ts ){
	ts.sort(function(a,b){
		if(a.parent === b.parent){
			return a.order - b.order;
		}else{
			var aas = evaluateTaskAncestor(a.id),
				abs = evaluateTaskAncestor(b.id),
				maxlen = Math.max(aas.length, abs.length);
			for(var i = 0; i < maxlen; i++ ){
				if(i>=aas.length){
					return a.order - TaskMap[abs[i]].order <= 0 ? -1 : 1;
				}
				if(i>=abs.length){
					return TaskMap[aas[i]].order - b.order >= 0? 1: -1;
				}
				if(aas[i]!==abs[i]){
					return TaskMap[aas[i]].order - TaskMap[abs[i]].order;
				}
			}
			return 0;
		}
	});
	return ts;
}


function initTree(options){
	options = options || {};
	$('.tree').treegrid({
		treeColumn: 1,
		expanderExpandedClass: 'uk-icon-folder-open-o',
		expanderCollapsedClass: 'uk-icon-folder-o',
		nodeClasses: {
			user:'uk-icon-user',
			manager: 'uk-icon-manage',
			manager_duputy: 'uk-icon-manage-deputy'
		},
		draggable: true, 
		//onMove: moveDepartment,
		selectable: true,
		selectedClass: 'uk-active',
		onSelected:options.onSelected
	});
}

function init(data){

}

var styles = {
	smallwidth: {
		width: "5%"
	},
	nopadding: {
		padding: "0"
	},
	gap: {
		marginRight: "10px"
	},
	textareaheight: { height: "60px"}
};

var tabs = [
	{ type:'view', title: '概况' },
	{ type:'edit', title: '编辑' },
	{ type:'log', title: '进展' }
];

var difficulties = [ '简单', '普通', '困难'];

var TaskTabView = React.createClass({	
	render: function(){
		var task = this.props.task;
		return ( 
			<div>
				<table className="uk-table dv-border">
					<tbody>
						<tr>
							<td className="uk-width-2-10 uk-block-muted">任务名称：</td>
							<td className="uk-width-3-10">{task.name}</td>
							<td className="uk-width-2-10 uk-block-muted">工期(天)：</td>
							<td className="uk-width-3-10">{task.duration}</td>
						</tr>
						<tr>
							<td className="uk-width-2-10 uk-block-muted">执行人：</td>
							<td className="uk-width-3-10">{task.executor_name}</td>
							<td className="uk-width-2-10 uk-block-muted">工作审核人：</td>
							<td className="uk-width-3-10">{task.manager_name}</td>
						</tr>
						<tr>
							<td className="uk-width-2-10 uk-block-muted">计划模式：</td>
							<td className="uk-width-3-10">{task.automode ? '自动' : '手动'}</td>
							<td className="uk-width-2-10 uk-block-muted">任务难度：</td>
							<td className="uk-width-3-10">{ difficulties[task.difficulty]}</td>
						</tr>
						<tr>
							<td className="uk-width-2-10 uk-block-muted">开始时间：</td>
							<td className="uk-width-3-10">{ formatDate(task.start_time) } </td>
							<td className="uk-width-2-10 uk-block-muted">计划开始时间：</td>
							<td className="uk-width-3-10">{ formatDate(task.plan_start_time)}</td>	
						</tr>
						<tr>
							<td className="uk-width-2-10 uk-block-muted">结束时间：</td>
							<td className="uk-width-3-10">{ formatDate(task.end_time)}</td>
							<td className="uk-width-2-10 uk-block-muted">计划结束时间：</td>
							<td className="uk-width-3-10">{ formatDate(task.plan_end_time)}</td>
						</tr>
						<tr>
							<td className="uk-block-muted">任务说明:</td>
							<td colSpan="3" >{ task.details }</td>
						</tr>
					</tbody>
				</table>
			</div>
			)
	}
});

var TaskTabEdit = React.createClass({
	render: function(){
		return ( 
			<div></div>
			)
	}
});


var TaskTabLog = React.createClass({
	render: function(){
		return ( 
			<div></div>
			)
	}
});


var TaskDialog = React.createClass({
	getInitialState: function() {
		return {task: this.props.task, tab: 'view'};
	},
	onSwitch: function(type){
		this.setState({tab:type});
	},
	render: function(){
		var task = this.state.task;
		return (
			<div id={'modal_' + task.id} className="uk-modal">
				<div className="uk-modal-dialog uk-modal-dialog-large">
					<a href="#" className="uk-modal-close uk-close uk-close-alt"></a>
					<div className="uk-modal-header"><h2>任务：{task.name}</h2></div>
					
					<div>
						<div className="uk-grid">
							<div className="uk-width-medium-1-10">
								<ul className="uk-tab uk-tab-left" data-uk-tab={"{connect:'#tab-" + task.id +"'}"}>
									{ 
										this.props.tabs.map(function(t){
											return ( 
												<li key={'tab_view_'+t.type} id={'tab_view_'+task.id} className={ this.state.tab == t.type ? "uk-active": '' } onClick={this.onSwitch.bind(this,t.type)}>
													<a href="#" >{t.title}</a>
												</li>)
										}.bind(this))
									}
								</ul>
							</div>
							<div className="uk-width-medium-9-10">
								<ul id={"tab-" + task.id} className="uk-switcher">
									<li className={ this.state.tab == 'view' ? "uk-active": '' }>
										<TaskTabView task={this.state.task}/>
									</li>
									<li className={ this.state.tab == 'edit' ? "uk-active": '' }>
										<TaskTabEdit task={this.state.task}/>
									</li>
									<li className={ this.state.tab == 'log' ? "uk-active": '' }>
										<TaskTabLog task={this.state.task}/>
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
			);
	}
});


var Task = React.createClass({
	getInitialState: function() {
		return {task: this.props.task, detail_shown: false };
	},
	onToggle: function(e){
		e.preventDefault();
		this.setState({detail_shown: !this.state.detail_shown})
	},
	render: function(){
		var task = this.state.task,
			parentCls = task.parent !=='root' ? 'treegrid-parent-' + task.parent : '',
			plan_mode = task.automode ? '自动' : '手动',
			start_time = task.status=='created'?formatDate(task.plan_start_time): formatDate(task.start_time),
			end_time = task.status=='created'?formatDate(task.plan_end_time): formatDate(task.end_time);
		
		return (
			<tr id={task.id} key={task.id} className={ 'treegrid-' + task.id + ' ' + parentCls}>
				<td className="uk-block-muted"><button  className="uk-button-link dv-link">{this.props.index}</button></td>
				<td><a className="dv-link-black"  href={'#modal_'+task.id} data-uk-modal="{center:true}">{task.name}</a>
					<TaskDialog task={task} tabs={tabs}/>
				</td>
				<td>{task.executor_name}</td>
				<td>{task.duration}</td>
				<td>{plan_mode}</td>
				<td>{start_time}</td>
				<td>{end_time}</td>
			</tr>
			);
	}
});



var TaskTable = React.createClass({
	getInitialState: function() {
		return {taskLen: 0};
	},
	resetTree: function(){
		initTree({
			onSelected: this.props.onTaskSelected
		});
	},
	componentDidUpdate:function(){
		if( this.props.tasks.length !== this.state.taskLen ){
			this.resetTree();
			this.setState({taskLen:this.props.tasks.length})
		}
	},
	render: function(){
		return (
			<table id="treeTask" className="tree uk-table uk-width-1-1 uk-table-condensed">
				<thead>
					<tr>
						<th style={styles.smallwidth}>标识</th>
						<th className="uk-width-3-10">任务名称</th>
						<th className="uk-width-2-10">负责人</th>
						<th className="uk-width-1-10">工期(天)</th>
						<th className="uk-width-1-10">计划模式</th>
						<th className="uk-width-1-10">开始时间</th>
						<th className="uk-width-1-10">结束时间</th>		
					</tr>
				</thead>
				<tbody>
					{ this.props.tasks.map(function(t, index){
							return <Task key={t.id} task={t} index={index} />
						})
					}
				</tbody>
			</table>
			);
	}
});

var NewTaskDlg = React.createClass({
	correctErrMsg: function(err){
		var error_msgs = {
			end_time: '请选择结束时间',
			master: '请选择项目负责人'
		};
		_.each(err, function(e,n){
			if(error_msgs.hasOwnProperty(e.data) && !e.message){
				e.message = options.error_msgs[e.data];
			}
		});
	},
	resetFields: function(){
		this.refs.name.value = ""
		this.refs.executor.value = this.props.users[0].id;
		this.refs.duration.value = 0;
		this.refs.automode.value = 0;
		this.refs.start_time.value = formatNow();
		this.refs.end_time.value = formatNow();
		this.refs.rely_to.value = "";
		this.refs.difficulty.value = 0;
		this.refs.details.value = "";
	},
	getPostData: function(){
		var name = this.refs.name.value.trim(),
			executor = this.refs.executor.value,
			duration = parseInt(this.refs.duration.value),
			automode = parseInt(this.refs.automode.value),
			start_time = this.refs.start_time.value||0,
			end_time = this.refs.end_time.value||0,
			rely_to = this.refs.rely_to.value.trim(),
			difficulty = parseInt(this.refs.difficulty.value),
			details = this.refs.details.value;
		
		var data = {
			name: name,
			parent: this.props.parent,
			executor: executor,
			duration: duration,
			start_time: toDateTime(start_time),
			automode: automode,
			end_time: toDateTime(end_time),
			rely_to: rely_to,
			difficulty: difficulty,
			details: details
		};
		//console.log(data)
		if(validateJsonObj('createTask', data)){
			if(data.start_time > data.end_time){
				throw  { error:'invalid parameter', data:'end_time', message:"结束时间应该大于开始时间"}; 
			}
			if( data.automode == 0 && !data.rely_to){
				throw { error:'invalid parameter', data:'rely_to', message:"计划模式为自动时，需要设置依赖任务"}
			}
			if( !/^[0-9\,]{0,50}$/.test(data.rely_to)){
				throw { error:'invalid parameter', data:'rely_to', message:"依赖的任务只可输入整数与英文逗号"}
			}
			return data;
		}
	},
	handleSubmit: function(e){
		e.preventDefault();		
		var data,
			form = $('#modal_new_task').find('form');
		try{
			data = this.getPostData();
			form.showFormError();//clear error tip
		}catch(e){
			this.correctErrMsg(e);
			form.showFormError(e);
			return;
		}
		form.postJSON( '/api/project/p/{{__id}}/task', data, function(err, result){
			if( !err ){
				var modal = UIkit.modal("#modal_new_task");
				modal.hide();
				this.resetFields();
				this.props.onNewTask(result.id);
			}
		}.bind(this));

	},
	render: function(){
		return (
			<div id="modal_new_task" className="uk-modal uk-text-left">
				<div className="uk-modal-dialog">
					<a href="" className="uk-modal-close uk-close uk-close-alt"></a>
					<div className="uk-modal-header "><h2>创建新任务</h2></div>
					<div>
						<form className="uk-form uk-form-stacked uk-form-horizontal">
							<fieldset>
								<div className="uk-alert uk-alert-danger uk-hidden"></div>
								<div className="uk-form-row uk-width-2-3">
									<label className="uk-form-label">名称</label>
									<div className="uk-form-controls">
										<input name="name" type="text" ref="name" className="uk-width-1-1" autofucus placeholder="3-50字符" defaultValue="" maxLength="50"/>
									</div>
								</div>
								<div className="uk-form-row uk-width-2-3">
									<label className="uk-form-label">父任务</label>
									<div className="uk-form-controls">
										<span>{this.props.parent=='root'?'无':TaskMap[this.props.parent].name}</span>
									</div>
								</div>
								<div className="uk-form-row" >
									<label className="uk-form-label">负责人</label>
									<div className="uk-form-controls uk-width-1-3">
										<select name="executor" ref="executor" className="uk-width-1-1">
											{ this.props.users.map(function(u){
												return <option key={u.id} value={u.id}>{u.name}</option>
												})
											}
										</select>
									</div>
								</div>
								<div className="uk-form-row">
									<label className="uk-form-label">工期（小时）</label>
									<div className="uk-form-controls uk-width-1-3">
										<input type="number" name="duration" ref="duration" placeholder="填入整数" defaultValue="0"/>
									</div>
								</div>
								<div className="uk-form-row">
									<label className="uk-form-label">计划模式</label>
									<div className="uk-form-controls uk-width-1-3">
										<select name="automode" ref="automode" className="uk-width-1-1">
											<option value="0">自动</option>
											<option value="1">手动</option>
										</select>
									</div>
								</div>
								<div className="uk-form-row">
									<label className="uk-form-label">开始时间</label>
									<div className="uk-form-controls uk-width-1-3">
										<div className="uk-form-icon">
											<i className="uk-icon-calendar"></i>
											<input type="text" name="start_time" ref="start_time" data-uk-datepicker="{weekstart:0, format:'YYYY-MM-DD'}" defaultValue={formatNow()}/>
										</div>
									</div>
								</div>
								<div className="uk-form-row">
									<label className="uk-form-label">结束时间</label>
									<div className="uk-form-controls uk-width-1-3">
										<div className="uk-form-icon">
											<i className="uk-icon-calendar"></i>
											<input type="text" name="end_time" ref="end_time" data-uk-datepicker="{weekstart:0, format:'YYYY-MM-DD'}" defaultValue={formatNow()}/>
										</div>
									</div>
								</div>								
								<div className="uk-form-row uk-width-1-1">
									<label className="uk-form-label">前置任务</label>
									<div className="uk-form-controls uk-width-1-3">
										<input type="text" name="rely_to" ref="rely_to" placeholder="填写标识，用逗号分隔" />
									</div>
								</div>
								<div className="uk-form-row">
									<label className="uk-form-label">任务难度</label>
									<div className="uk-form-controls uk-width-1-3">
										<select name="difficulty" ref="difficulty" className="uk-width-1-1">
											<option value="0">简单</option>
											<option value="1">普通</option>
											<option value="2">困难</option>
										</select>
									</div>
								</div>
								<div className="uk-form-row uk-width-1-1">
									<label className="uk-form-label">任务说明</label>
									<div className="uk-form-controls">
										<textarea ref="details" name="details" className="uk-width-2-3" style={styles.textareaheight} placeholder="可暂时不填">
										</textarea>
									</div>
								</div>
							</fieldset>
						</form>
					</div>
					<div className="uk-modal-footer uk-text-right">
						<button type="button" onClick={this.handleSubmit} className="uk-button uk-button-primary">保存</button>
					</div>
				</div>
			</div>
			)
	}
});

var ToolBar = React.createClass({
	getInitialState: function() {
		return {new_task_parent:'root'};
	},
	handleNewTask: function(parent){
		this.setState({new_task_parent:parent});
	},
	render: function(){
		return (
			<div className="uk-grid">
				<div className="uk-width-1-3">
					添加任务：
					<a className="dv-link" href={'#modal_new_task'} onClick={this.handleNewTask.bind(this,'root')} data-uk-modal="{center:true}">顶级</a>、
					<a className="dv-link" href={'#modal_new_task'} onClick={this.handleNewTask.bind(this,evaluateTaskParent(this.props.selected_task))} data-uk-modal="{center:true}">同级</a>、
					<a className="dv-link" href={'#modal_new_task'} onClick={this.handleNewTask.bind(this,this.props.selected_task)} data-uk-modal="{center:true}">下属</a>
					<NewTaskDlg users={this.props.users} parent={this.state.new_task_parent} onNewTask={this.props.onNewTask}/>
				</div>
			</div>
			)
	}
});

var Project = React.createClass({
	getInitialState: function() {
		return {project: {}, users:[], tasks:[], selected_task:'root' };
	},
	onNewTask: function(id){
		getJSON( '/api/project/task/'+id, function(err, data ){
				if(!err){
					var t = data,
						ts = this.state.tasks;
					t.executor_name = UserMap[t.executor_id].name;
					TaskMap[t.id] = t;
					ts.push(t);
					sortTasks(ts);
					this.setState({tasks:ts});
				}
			}.bind(this)
		); 
	},
	onTaskSelected: function(id){
		this.setState({selected_task:id});
	},	
	loadTasks: function(){
		getJSON( '/api/project/p/{{__id}}/tasklist', function(err, data ){
				readyElement('vm');
				if(err){
					fatal(err);
				}else{
					data.forEach( function(t, index) {
						t.executor_name = UserMap[t.executor_id].name;
					});
					makeTaskMap(data);		
					this.setState({tasks:sortTasks(data)});
				}
			}.bind(this)
		);
	},
	componentDidMount: function(){
		loadingElement('vm');
		getJSON( '/api/project/p/{{__id}}', function(err, data ){				
				if(err){
					fatal(err);
				}else{
					makeUserMap(data.members);
					this.setState({project:data, users: data.members});
					this.loadTasks();					
				}
			}.bind(this)
		);
		
	},	
	render: function(){
		return (
			<div className="uk-width-1-1">				
				<h2 className="x-title">项目: {this.state.project.name}</h2>
				<ToolBar users={this.state.users} onNewTask={this.onNewTask} selected_task={this.state.selected_task}/>				
				<hr className="dv-hr"/>
				<TaskTable tasks={this.state.tasks} onTaskSelected={this.onTaskSelected}/>
			</div>
			);
	}
});

ReactDOM.render(
	<Project url=""/>,
	document.getElementById('vm')
	);

</script>

{% endblock %}


{% block content %}
<div id="content-block" class="dv-container x-content" style="max-width:1080px">
	<div id="vm" class="dv-container uk-width-1-1"  style="max-width:1080px">
		
	</div>
</div>
{% endblock %}


