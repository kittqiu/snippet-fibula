"use strict";var SelectUserDialog=React.createClass({displayName:"SelectUserDialog",loadFreeUsers:function(){getJSON("/api/team/department/freeusers",function(e,t){e?fatal(e):this.setState({users:t})}.bind(this))},handleSubmit:function(){var e,t=$("#modal_add_member input:checked"),a=[],n=[],r=[],s=this.state.users;for(e=0;e<t.length;e++)a.push(t[e].value);for(e=0;e<s.length;e++){var i=s[e];-1!==a.indexOf(i.id)?r.push(i):n.push(i)}this.props.addUsers(r);var d=UIkit.modal("#modal_add_member");d.hide()},componentWillMount:function(){this.loadFreeUsers()},componentWillReceiveProps:function(e){e.dataUpdatedCnt!==this.state.dataUpdatedCnt&&this.loadFreeUsers()},getInitialState:function(){return{users:[],dataUpdatedCnt:0}},render:function(){return React.createElement("div",{id:"modal_add_member",className:"uk-modal uk-text-left"},React.createElement("div",{className:"uk-modal-dialog"},React.createElement("a",{href:"",className:"uk-modal-close uk-close uk-close-alt"}),React.createElement("div",{className:"uk-modal-header "},React.createElement("h2",null,"选择新成员")),React.createElement("div",null,React.createElement("form",{className:"uk-form uk-form-stacked uk-form-horizontal"},React.createElement("fieldset",null,React.createElement("div",{className:"uk-alert uk-alert-danger uk-hidden"}),this.state.users.map(function(e,t){return React.createElement("div",{key:e.id,className:"uk-form-controls"},React.createElement("input",{id:e.id,type:"checkbox",value:e.id}),React.createElement("label",{htmlFor:e.id},e.name))}),React.createElement("div",{className:this.state.users.length>0?"uk-hidden":""},"无新成员")))),React.createElement("div",{className:"uk-modal-footer uk-text-right"},React.createElement("button",{type:"button",onClick:this.handleSubmit,className:"uk-button uk-button-primary"},"提交"))))}}),Department=React.createClass({displayName:"Department",render:function(){var e=this.props.dep,t="root"!==e.parent?"treegrid-parent-"+e.parent:"";return"user"===e.type?React.createElement("tr",{id:e.id,className:"treegrid-"+e.id+" "+t,"data-treegrid-type":"user","data-treegrid-drag":"{droppable:false}"},React.createElement("td",null,e.name,React.createElement("div",{id:"modal_task_"+e.id,className:"uk-modal"}))):React.createElement("tr",{id:e.id,className:"treegrid-"+e.id+" "+t},React.createElement("td",null,e.name,React.createElement("div",{id:"modal_task_"+e.id,className:"uk-modal"})))}}),DepartmentTable=React.createClass({displayName:"DepartmentTable",dragDepartment:function(e,t,a){this.props.onDragDrop(e,t,a)},initTree:function(){$(".tree").treegrid({treeColumn:0,expanderExpandedClass:"uk-icon-folder-open-o",expanderCollapsedClass:"uk-icon-folder-o",nodeClasses:{user:"uk-icon-user"},draggable:"rw"===this.props.mode,onMove:this.dragDepartment,selectable:!0,selectedClass:"dv-row-selected",onSelected:this.props.onItemSelected,leafClass:"uk-icon-leaf"})},getInitialState:function(){return{depLen:0,updatedCnt:0}},componentDidUpdate:function(){this.props.deps.length!==this.state.depLen&&(this.initTree(),this.setState({depLen:this.props.deps.length})),this.props.updatedCnt!==this.state.updatedCnt&&(this.initTree(),this.setState({updatedCnt:this.props.updatedCnt}))},render:function(){return React.createElement("div",null,React.createElement("table",{id:"tree",className:"tree uk-table uk-table-hover uk-width-1-1 uk-table-condensed"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"部门列表"))),React.createElement("tbody",null,this.props.deps.map(function(e,t){return React.createElement(Department,{key:e.id,dep:e})}.bind(this)))))}}),ToolBar=React.createClass({displayName:"ToolBar",handleMove:function(e){var t=this.props.selectedItem,a=this.props.deps;"root"!==t.id&&postJSON("/api/team/department/"+t.id+"/order",{action:e},function(n,r){if(!n){if("up"===e){for(var s=t.index-1;s>=0;s--){var i=a[s];if(i.parent===t.parent&&"department"===i.type){i.order+=1;break}}t.order--}else{for(var s=t.index+1;s<a.length;s++){var i=a[s];if(i.parent===t.parent&&"department"===i.type){i.order-=1;break}}t.order++}this.props.onDataChanged()}}.bind(this))},handleChangeParent:function(e){var t=this.props.selectedItem;"root"!==t.id&&this.props.handleDepChangeParent(t,e)},handleJump:function(e){location.assign(e)},handleDelete:function(){var e=this.props.selectedItem,t=this.props.deps;"root"!==e.id&&(this.hasChildren(e)||("department"===e.type?postJSON("/api/team/department/"+e.id+"/delete",function(a,n){if(null!==a)console.log(a);else{for(var r=e.index+1;r<t.length;r++){var s=t[r];s.parent===e.parent&&s.order--}t.splice(e.index,1),this.props.onDataChanged()}}.bind(this)):postJSON("/api/team/member/u/"+e.id,{department:""},function(a,n){null!==a?console.log(a):(t.splice(e.index,1),this.props.onDataChanged())}.bind(this))))},hasChildren:function(e){var t=this.props.deps;if("user"===e.type)return!1;for(var a=e.index+1;a<t.length;a++){var n=t[a];if(n.parent===e.id)return!0}return!1},canDown:function(e){var t=this.props.deps;if("department"===e.type)for(var a=e.index+1;a<t.length;a++){var n=t[a];if(n.parent===e.parent&&"department"===n.type)return!0}return!1},canUp:function(e){var t=this.props.deps;if("department"===e.type)for(var a=e.index-1;a>=0;a--){var n=t[a];if(n.id===e.parent)break;if(n.parent===e.parent&&"department"===n.type)return!0}return!1},getInitialState:function(){return{disabledDown:!0,disabledUp:!0,disabledRoot:!0,disabledAddMember:!0}},componentWillReceiveProps:function(e){},render:function(){var e=this.props.selectedItem,t={marginRight:"0px"},a=!this.canDown(e),n=!this.canUp(e),r=!0,s=!0,i=!0,d=!0,l=this.hasChildren(e);return"department"===e.type&&(i=!1,"root"!==e.id?(d=!1,s=!1,"root"!==e.parent&&(r=!1)):l=!0),React.createElement("div",{className:"uk-grid"},React.createElement("div",{className:"uk-width-1-3"},"添加：",React.createElement("button",{className:"uk-button-link dv-link",onClick:this.handleJump.bind(this,"/team/structure/department/creation"),style:t},"顶级部门"),"、",React.createElement("button",{className:"uk-button-link dv-link",onClick:this.handleJump.bind(this,"/team/structure/department/creation?parent="+e.id),disabled:i,style:t},"下级部门"),"、",React.createElement("button",{className:"uk-button-link dv-link","data-uk-modal":"{center:true,target:'#modal_add_member'}",disabled:s,style:t},"下属成员"),React.createElement(SelectUserDialog,{dataUpdatedCnt:this.props.updatedCnt,addUsers:this.props.addUsers})),React.createElement("div",{className:"uk-width-1-3"},"移动：",React.createElement("button",{className:"uk-button-link dv-link",onClick:this.handleMove.bind(this,"up"),disabled:n,style:t},"上移"),"、",React.createElement("button",{className:"uk-button-link dv-link",onClick:this.handleMove.bind(this,"down"),disabled:a,style:t},"下移"),"、",React.createElement("button",{className:"uk-button-link dv-link",onClick:this.handleChangeParent.bind(this,"root"),disabled:r,style:t},"置为顶级部门")),React.createElement("div",{className:"uk-width-1-3"},"其它：",React.createElement("button",{className:"uk-button-link dv-link",onClick:this.handleJump.bind(this,"/team/structure/department/"+e.id+"/edit"),disabled:d,style:t},"修改"),"、",React.createElement("button",{className:"uk-button-link dv-link",onClick:this.handleDelete,disabled:l,style:t},"删除")),React.createElement("ul",{className:"uk-nav uk-nav-menu","data-uk-scrollspy-nav":"{closest:'li', smoothscroll:false}"},React.createElement("li",null,"添加"),React.createElement("li",null,React.createElement("button",{className:"uk-button-link dv-link",onClick:this.handleJump.bind(this,"/team/structure/department/creation")},"顶级部门")),React.createElement("li",null,React.createElement("button",{className:"uk-button-link dv-link",onClick:this.handleJump.bind(this,"/team/structure/department/creation?parent="+e.id),disabled:i},"下级部门")),React.createElement("li",null,React.createElement("button",{className:"uk-button-link dv-link",href:"#modal_new_task","data-uk-modal":"{center:true}",disabled:s},"下属成员")),React.createElement("li",null,"移动"),React.createElement("li",null,React.createElement("button",{className:"uk-button-link dv-link",onClick:this.handleMove.bind(this,"up"),disabled:n},"上移")),React.createElement("li",null,React.createElement("button",{className:"uk-button-link dv-link",onClick:this.handleMove.bind(this,"down"),disabled:a},"下移")),React.createElement("li",null,React.createElement("button",{className:"uk-button-link dv-link",onClick:this.handleChangeParent.bind(this,"root"),disabled:r},"置为顶级部门")),React.createElement("li",null,"其它"),React.createElement("li",null,React.createElement("button",{className:"uk-button-link dv-link",onClick:this.handleJump.bind(this,"/team/structure/department/"+e.id+"/edit"),disabled:d,style:t},"修改")),React.createElement("li",null,React.createElement("button",{className:"uk-button-link dv-link",onClick:this.handleDelete,disabled:l,style:t},"删除"))))}}),Structure=React.createClass({displayName:"Structure",initDepMap:function(e){for(var t=this.state.DepMap,a=0;a<e.length;a++){var n=e[a];n.type="department",t[n.id]=n}},initUserMap:function(e){for(var t=this.state.UserMap,a=0;a<e.length;a++){var n=e[a];n.type="user",n.order=0,n.parent=n.department,t[n.id]=n}},initItemAttr:function(e){e.forEach(function(e,t){e.index=t})},evaluateAncestor:function(e){var t=this.state.DepMap,a=this.state.UserMap,n=[];if("root"!==e)if(t.hasOwnProperty(e)){var r=e;do{var s=t[r];n.unshift(s.parent),r=s.parent}while("root"!==r)}else if(a.hasOwnProperty(e)){var i=a[e].parent;for(n.push(i);"root"!==i;){var s=t[i];n.unshift(s.parent),i=s.parent}}return n},sortItem:function(e){var t=this.state.DepMap;this.state.UserMap;return e.sort(function(e,a){if(e.parent===a.parent)return"user"===e.type&&"department"===a.type?-1:"department"===e.type&&"user"===a.type?1:e.order-a.order;for(var n=this.evaluateAncestor(e.id),r=this.evaluateAncestor(a.id),s=Math.max(n.length,r.length),i=0;s>i;i++){if(i>=n.length)return"user"===e.type?-1:e.order-t[r[i]].order<=0?-1:1;if(i>=r.length)return"user"===a.type?1:t[n[i]].order-a.order>=0?1:-1;if(n[i]!==r[i])return t[n[i]].order-t[r[i]].order}return 0}.bind(this)),this.initItemAttr(e),e},loadUsers:function(e){getJSON("/api/team/department/users",function(t,a){t?fatal(t):(this.initUserMap(a),e=e.concat(a),e=this.sortItem(e),this.setState({data:e}))}.bind(this))},loadData:function(){getJSON("/api/team/department/list",function(e,t){e?fatal(e):(this.initDepMap(t),this.loadUsers(t))}.bind(this))},handleDepChangeParent:function(e,t){var a={name:e.name,pid:t},n=this.state.data;"user"!==e.type&&e.parent!==t&&postJSON("/api/team/department/"+e.id,a,function(a,r){if(!a){var s;for(s=e.index+1;s<n.length;s++){var i=n[s];i.parent===e.parent&&"department"===i.type&&(i.order-=1)}for(e.order=0,s=n.length-1;s>=0;s--){var i=n[s];if(i.parent===t&&"department"===i.type){e.order=i.order+1;break}}e.parent=t,this.onDataChanged()}}.bind(this))},hasBloodRelation:function(e,t){var a=this.evaluateAncestor(e),n=this.evaluateAncestor(t);return-1!==a.indexOf(t)||-1!==n.indexOf(e)?!0:!1},onDragDrop:function(e,t,a){var n,r=this.state.DepMap,s=this.state.UserMap;this.state.data;r.hasOwnProperty(e)?n=r[e]:s.hasOwnProperty(e)&&(n=s[e]),n.parent!==t&&t!==a&&("user"===n.type&&postJSON("/api/team/member/u/"+n.id,{department:t},function(e,a){e||(n.parent=t,this.onDataChanged(),console.log("department:"+t))}.bind(this)),"department"===n.type&&this.handleDepChangeParent(n,t))},addUsers:function(e){var t=this.state.selectedItem,a=this.state.data,n=[];e.forEach(function(e,r){var s={type:"user",department:t.id,parent:t.id,id:e.id,name:e.name};e.department=t.id,n.push(s),a.push(s)}),postJSON("/api/team/member/updateusers",e,function(e,t){e||(this.initUserMap(n),this.onDataChanged())}.bind(this))},onDataChanged:function(){var e=this.state.data;e=this.sortItem(e),this.setState({data:e,updatedCnt:this.state.updatedCnt+1})},onItemSelected:function(e){this.state.DepMap.hasOwnProperty(e)?this.setState({selectedItem:this.state.DepMap[e]}):this.state.UserMap.hasOwnProperty(e)&&this.setState({selectedItem:this.state.UserMap[e]})},componentWillMount:function(){this.loadData()},getInitialState:function(){var e={root:{id:"root",name:"root",parent:"none",type:"department"}};return{DepMap:e,UserMap:{},data:[],selectedItem:e.root,updatedCnt:0}},render:function(){return React.createElement("div",{className:"uk-width-1-1"},React.createElement("h2",{className:"x-title"},"部门架构"),"rw"===this.props.mode?React.createElement(ToolBar,{selectedItem:this.state.selectedItem,deps:this.state.data,updatedCnt:this.state.updatedCnt,onDataChanged:this.onDataChanged,handleDepChangeParent:this.handleDepChangeParent,addUsers:this.addUsers}):this.props.perm_edit?React.createElement("div",{className:"uk-text-right"},React.createElement("a",{href:"/team/structure/build",className:"dv-link"},"修改")):null,React.createElement("hr",{className:"dv-hr"}),React.createElement(DepartmentTable,{mode:this.props.mode,deps:this.state.data,onItemSelected:this.onItemSelected,updatedCnt:this.state.updatedCnt,onDragDrop:this.onDragDrop}))}});