"use strict";var TeamItem=React.createClass({displayName:"TeamItem",render:function(){var e=this.props.dep,t="root"!==e.parent?"treegrid-parent-"+e.parent:"";return"user"===e.type?React.createElement("tr",{id:e.id,className:"treegrid-"+e.id+" "+t,"data-treegrid-type":"user","data-treegrid-drag":"{droppable:false}"},React.createElement("td",null,e.name,React.createElement("div",{id:"modal_task_"+e.id,className:"uk-modal"}))):React.createElement("tr",{id:e.id,className:"treegrid-"+e.id+" "+t},React.createElement("td",null,e.name,React.createElement("div",{id:"modal_task_"+e.id,className:"uk-modal"})))}}),StructureTree=React.createClass({displayName:"StructureTree",initDepMap:function(e){for(var t=this.state.DepMap,a=0;a<e.length;a++){var r=e[a];r.type="department",t[r.id]=r}},initUserMap:function(e){for(var t=this.state.UserMap,a=0;a<e.length;a++){var r=e[a];r.type="user",r.order=0,r.parent=r.department,t[r.id]=r}},initItemAttr:function(e){e.forEach(function(e,t){e.index=t})},evaluateAncestor:function(e){var t=this.state.DepMap,a=this.state.UserMap,r=[];if("root"!==e)if(t.hasOwnProperty(e)){var n=e;do{var s=t[n];r.unshift(s.parent),n=s.parent}while("root"!==n)}else if(a.hasOwnProperty(e)){var i=a[e].parent;for(r.push(i);"root"!==i;){var s=t[i];r.unshift(s.parent),i=s.parent}}return r},sortItem:function(e){var t=this.state.DepMap;this.state.UserMap;return e.sort(function(e,a){if(e.parent===a.parent)return"user"===e.type&&"department"===a.type?-1:"department"===e.type&&"user"===a.type?1:e.order-a.order;for(var r=this.evaluateAncestor(e.id),n=this.evaluateAncestor(a.id),s=Math.max(r.length,n.length),i=0;s>i;i++){if(i>=r.length)return"user"===e.type?-1:e.order-t[n[i]].order<=0?-1:1;if(i>=n.length)return"user"===a.type?1:t[r[i]].order-a.order>=0?1:-1;if(r[i]!==n[i])return t[r[i]].order-t[n[i]].order}return 0}.bind(this)),this.initItemAttr(e),e},loadUsers:function(e){getJSON("/api/team/department/users",function(t,a){t?fatal(t):(this.initUserMap(a),e=e.concat(a),e=this.sortItem(e),this.setState({data:e,initTreeOnce:!0}),this.props.updateUserData&&this.props.updateUserData(this.state.UserMap))}.bind(this))},loadData:function(){getJSON("/api/team/department/list",function(e,t){e?fatal(e):(this.initDepMap(t),this.loadUsers(t),this.props.updateDepData&&this.props.updateDepData(this.state.DepMap))}.bind(this))},initTree:function(){$(".tree").treegrid({treeColumn:0,expanderExpandedClass:"uk-icon-folder-open-o",expanderCollapsedClass:"uk-icon-folder-o",nodeClasses:{user:"uk-icon-user"},draggable:!1,selectable:!0,selectedClass:"dv-row-selected",onSelected:this.onItemSelected,leafClass:"uk-icon-leaf"})},listDepMembers:function(e){var t=this.state.UserMap,a=[];for(var r in t){var n=t[r],s=this.evaluateAncestor(n.id);-1!==s.indexOf(e)&&a.push(n.id)}return a},onItemSelected:function(e){var t="user",a=[];this.state.DepMap.hasOwnProperty(e)?(this.setState({selectedItem:this.state.DepMap[e]}),t="department",a=this.listDepMembers(e)):this.state.UserMap.hasOwnProperty(e)&&(this.setState({selectedItem:this.state.UserMap[e]}),t="user"),this.props.onSelected(t,e,a)},componentWillMount:function(){this.loadData()},componentDidUpdate:function(){this.state.initTreeOnce&&(this.initTree(),this.setState({initTreeOnce:!1}))},getInitialState:function(){var e={root:{id:"root",name:"root",parent:"none",type:"department"}};return{DepMap:e,UserMap:{},data:[],selectedItem:e.root,updatedCnt:0,initTreeOnce:!1}},render:function(){return React.createElement("div",null,React.createElement("table",{id:"tree",className:"tree uk-table uk-table-hover uk-width-1-1 uk-table-condensed"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"部门与成员"))),React.createElement("tbody",null,this.state.data.map(function(e,t){return React.createElement(TeamItem,{key:e.id,dep:e})}.bind(this)))))}});